(()=>{"use strict";class e{constructor(e,t,n,s){this._id=e,this._name=t,this._wins=n,this._status=s}name(){return this._name}wins(){return this._wins}status(){return this._status}}class t{constructor(e){this._mediator=e}build(){let t=document.createElement("form"),n=document.createElement("input"),s=document.createElement("button");return s.innerHTML="Войти",t.addEventListener("submit",(t=>{t.preventDefault();let s=new e(1,n.value,0,"fff");return this._mediator.setPlayer(s),this._mediator.handleEvent("auth"),!1})),t.appendChild(n),t.appendChild(s),t}}class n{constructor(e){this._players=e}build(){let e=document.createElement("div"),t=document.createElement("ul");for(let e=0;e<this._players.length;e++){let n=document.createElement("li");console.log(this._players),n.innerHTML=`${this._players[e].name()}, wins: ${this._players[e].wins()}, status: ${this._players[e].status()}`,t.appendChild(n)}return e.appendChild(t),e}}class s{constructor(e,t,n){this._url=e,this._socket=t,this._playerName=n,this.pong()}setMessageHandler(e){this._socket.onmessage=e}send(e){1===this._socket.readyState&&this._socket.send(e)}pong(){this._socket?0!==this._socket.readyState?1===this._socket.readyState?(this._socket.send("heartbeat: "+this._playerName),setTimeout((()=>this.pong()),3e4)):console.log("err 2",this._socket):setTimeout(this.pong,1e3):console.log("err 1",this._socket)}}class o{constructor(e){this._container=e,this._webSocketAddress=this._container.getAttribute("ws-server")}handleEvent(o){return i=this,r=void 0,l=function*(){if("start"===o){let e=new t(this);this._container.appendChild(e.build())}if("auth"===o){let e=yield(i=this._webSocketAddress,new Promise((function(e,t){var n=new WebSocket(i);n.onclose=function(e){e.wasClean?console.log("Соединение закрыто чисто"):console.log("Обрыв соединения"),console.log("Код: "+e.code+" причина: "+e.reason),console.log(e)},n.onmessage=function(e){console.log("Получены данные "+e.data)},n.onerror=function(e){console.log(e)},n.onopen=function(){e(n)},n.onerror=function(e){t(e)}})));this._webSocketClient=new s(this._webSocketAddress,e,this._player.name()),this._webSocketClient.setMessageHandler((e=>{let t=JSON.parse(e.data);console.log(t),!0===t.ok&&this.handleEvent("players")})),this._webSocketClient.send(`{"controller": "Players", "action": "auth", "data":"${this._player.name()}"}`)}var i;"players"===o&&(this._webSocketClient.setMessageHandler((t=>{console.log(t.data,"players");let s=JSON.parse(t.data);if(!this.isObject(s))return;let o=[];for(let t in s)o.push(new e(0,s[t].name,s[t].wins,s[t].status));let i=new n(o);this._container.appendChild(i.build())})),this._webSocketClient.send('{"controller": "Players", "action":"getPlayers", "data": ""}'))},new((a=void 0)||(a=Promise))((function(e,t){function n(e){try{o(l.next(e))}catch(e){t(e)}}function s(e){try{o(l.throw(e))}catch(e){t(e)}}function o(t){var o;t.done?e(t.value):(o=t.value,o instanceof a?o:new a((function(e){e(o)}))).then(n,s)}o((l=l.apply(i,r||[])).next())}));var i,r,a,l}MessageHandler(e){let t=JSON.parse(e.data);t.controller,t.args,new t.controller(this).index(t.args)}isObject(e){return null!==e&&"object"==typeof e}setPlayer(e){this._player=e}}window.addEventListener("load",(()=>new class{constructor(e){this._selector=e}run(){return e=this,t=void 0,s=function*(){this._container=document.querySelector(this._selector),new o(this._container).handleEvent("start")},new((n=void 0)||(n=Promise))((function(o,i){function r(e){try{l(s.next(e))}catch(e){i(e)}}function a(e){try{l(s.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}l((s=s.apply(e,t||[])).next())}));var e,t,n,s}}("#app").run()))})();
//# sourceMappingURL=app.js.map