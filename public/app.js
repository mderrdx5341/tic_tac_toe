(()=>{"use strict";class e{constructor(e){this._container=e,this._playerPanel=document.createElement("div"),this._playerPanel.className="player-info",this._playersPanel=document.createElement("div"),this._playerPanel.className="player-info"}build(){this._container.appendChild(this._playerPanel),this._container.appendChild(this._playersPanel)}playerPanel(){return this._playerPanel}playersPanel(){return this._playersPanel}}class t{constructor(e,t,n,s){this._id=e,this._name=t,this._wins=n,this._status=s}id(){return this._id}name(){return this._name}wins(){return this._wins}status(){return this._status}}class n{constructor(e){this._mediator=e}build(){let e=document.createElement("form"),n=document.createElement("input"),s=document.createElement("button");return s.innerHTML="Войти",e.addEventListener("submit",(e=>{e.preventDefault();let s=new t(1,n.value,0,"fff");return this._mediator.setPlayer(s),this._mediator.handleEvent("auth"),!1})),e.appendChild(n),e.appendChild(s),e}}class s{constructor(e,t,n){this._url=e,this._socket=t,this._playerName=n,this.pong()}setMessageHandler(e){this._socket.onmessage=e}send(e){1===this._socket.readyState&&this._socket.send(e)}pong(){this._socket?0!==this._socket.readyState?1===this._socket.readyState?(this._socket.send("heartbeat: "+this._playerName),setTimeout((()=>this.pong()),3e4)):console.log("err 2",this._socket):setTimeout(this.pong,1e3):console.log("err 1",this._socket)}}class a{constructor(e){this._player=e}build(){let e=document.createElement("div");return e.innerHTML=`<h3>name: ${this._player.name()}</h3><div>wins: ${this._player.wins()}</div>`,e}}class i{constructor(e){this._players=e}build(){let e=document.createElement("div"),t=document.createElement("ul");for(let e=0;e<this._players.length;e++){let n=document.createElement("li");console.log(this._players),n.setAttribute("id",this._players[e].id().toString()),n.innerHTML=`\n                ${this._players[e].name()},\n                wins: ${this._players[e].wins()},\n                <span class="status${this.statusClassModificator(this._players[e].status())}"> status: ${this._players[e].status()}</span>\n            `,t.appendChild(n)}return e.appendChild(t),e}statusClassModificator(e){switch(e){case"Offline":return" status--offline";case"Online":return" status--online"}}}let r={Players:class{constructor(e,t){this._mediator=e,this._webSocketClient=t}auth(e){if(console.log(e,"auth"),!0===e.ok){this._mediator.mainPage().playerPanel().innerHTML="";let n=new t(e.player.connect,e.player.name,e.player.wins,e.player.status),s=new a(n);this._mediator.mainPage().playerPanel().appendChild(s.build())}}players(e){if(console.log(e,"players"),!this.isObject(e.playersData))return;let n=[];for(let s in e.playersData)n.push(new t(e.playersData[s].connect,e.playersData[s].name,e.playersData[s].wins,e.playersData[s].status));let s=new i(n);this._mediator.mainPage().playersPanel().innerHTML="",this._mediator.mainPage().playersPanel().appendChild(s.build())}isObject(e){return null!==e&&"object"==typeof e}},Game:class{}};class l{constructor(t){this._container=t,this._webSocketAddress=this._container.getAttribute("ws-server"),this._mainPage=new e(this._container),this._mainPage.build()}handleEvent(e){return t=this,a=void 0,r=function*(){if("start"===e){let e=new n(this);this._mainPage.playerPanel().appendChild(e.build())}if("auth"===e){let e=yield(t=this._webSocketAddress,new Promise((function(e,n){var s=new WebSocket(t);s.onclose=function(e){e.wasClean?console.log("Соединение закрыто чисто"):console.log("Обрыв соединения"),console.log("Код: "+e.code+" причина: "+e.reason),console.log(e)},s.onmessage=function(e){console.log("Получены данные "+e.data)},s.onerror=function(e){console.log(e)},s.onopen=function(){e(s)},s.onerror=function(e){n(e)}})));this._webSocketClient=new s(this._webSocketAddress,e,this._player.name()),this._webSocketClient.setMessageHandler(this.MessageHandler.bind(this)),this._webSocketClient.send(`{"controller": "Players", "action": "auth", "data":"${this._player.name()}"}`)}var t;"players"===e&&this._webSocketClient.send('{"controller": "Players", "action":"getPlayers", "data": ""}')},new((i=void 0)||(i=Promise))((function(e,n){function s(e){try{o(r.next(e))}catch(e){n(e)}}function l(e){try{o(r.throw(e))}catch(e){n(e)}}function o(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(s,l)}o((r=r.apply(t,a||[])).next())}));var t,a,i,r}MessageHandler(e){let t=JSON.parse(e.data);new r[t.controller](this,this._webSocketClient)[t.action](t.args)}webSocketClient(){this._webSocketClient}container(){return this._container}mainPage(){return this._mainPage}setPlayer(e){this._player=e}}window.addEventListener("load",(()=>new class{constructor(e){this._selector=e}run(){return e=this,t=void 0,s=function*(){this._container=document.querySelector(this._selector),new l(this._container).handleEvent("start")},new((n=void 0)||(n=Promise))((function(a,i){function r(e){try{o(s.next(e))}catch(e){i(e)}}function l(e){try{o(s.throw(e))}catch(e){i(e)}}function o(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,l)}o((s=s.apply(e,t||[])).next())}));var e,t,n,s}}("#app").run()))})();
//# sourceMappingURL=app.js.map