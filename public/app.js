(()=>{"use strict";class e{constructor(e){this._container=e,this._playerPanel=document.createElement("div"),this._playerPanel.className="player-info",this._playersPanel=document.createElement("div"),this._playersPanel.className="players-list",this._gamePanel=document.createElement("div"),this._gamePanel.className="game-block"}build(){this._container.appendChild(this._playerPanel),this._container.appendChild(this._playersPanel),this._container.appendChild(this._gamePanel)}playerPanel(){return this._playerPanel}playersPanel(){return this._playersPanel}gamePanel(){return this._gamePanel}}class t{constructor(e,t,n,s){this._id=e,this._name=t,this._wins=n,this._status=s}id(){return this._id}name(){return this._name}wins(){return this._wins}status(){return this._status}}class n{constructor(e){this._mediator=e}build(){let e=document.createElement("form"),n=document.createElement("input"),s=document.createElement("button");return s.innerHTML="Войти",e.addEventListener("submit",(e=>{e.preventDefault();let s=new t(1,n.value,0,"fff");return this._mediator.setPlayer(s),this._mediator.handleEvent("auth"),!1})),e.appendChild(n),e.appendChild(s),e}}class s{constructor(e){this._mediator=e,this._cells=[]}build(){let e=document.createElement("div");e.className="game-board";for(let t=0;t<=8;t++){let n=document.createElement("div");n.className="game-board__cell",n.setAttribute("id",t.toString()),this._cells.push(n),e.appendChild(n)}return this.start(),e}start(){let e=0,t=this;console.log(this._cells);for(let n of this._cells)n.addEventListener("click",(function n(){this.textContent=["X","O"][e%2],this.removeEventListener("click",n),t.isVictory(t._cells)?alert(this.textContent):8==e&&alert("ничья"),e++}))}isVictory(e){let t=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];for(let n of t)if(e[n[0]].textContent==e[n[1]].textContent&&e[n[1]].textContent==e[n[2]].textContent&&""!=e[n[0]].textContent)return!0;return!1}}class a{constructor(e,t,n){this._url=e,this._socket=t,this._playerName=n,this.pong()}setMessageHandler(e){this._socket.onmessage=e}send(e){1===this._socket.readyState&&this._socket.send(e)}pong(){this._socket?0!==this._socket.readyState?1===this._socket.readyState?(this._socket.send("heartbeat: "+this._playerName),setTimeout((()=>this.pong()),3e4)):console.log("err 2",this._socket):setTimeout(this.pong,1e3):console.log("err 1",this._socket)}}class i{constructor(e){this._player=e}build(){let e=document.createElement("div");return e.innerHTML=`<h3>name: ${this._player.name()}</h3><div>wins: ${this._player.wins()}</div>`,e}}class r{constructor(e){this._players=e}build(){let e=document.createElement("div"),t=document.createElement("ul");for(let e=0;e<this._players.length;e++){let n=document.createElement("li");console.log(this._players),n.setAttribute("id",this._players[e].id().toString()),n.innerHTML=`\n                ${this._players[e].name()},\n                wins: ${this._players[e].wins()},\n                <span class="status${this.statusClassModificator(this._players[e].status())}"> status: ${this._players[e].status()}</span>\n            `,t.appendChild(n)}return e.appendChild(t),e}statusClassModificator(e){switch(e){case"Offline":return" status--offline";case"Online":return" status--online"}}}let l={Players:class{constructor(e,t){this._mediator=e,this._webSocketClient=t}auth(e){if(console.log(e,"auth"),!0===e.ok){this._mediator.mainPage().playerPanel().innerHTML="";let n=new t(e.player.connect,e.player.name,e.player.wins,e.player.status),s=new i(n);this._mediator.mainPage().playerPanel().appendChild(s.build())}}players(e){if(console.log(e,"players"),!this.isObject(e.playersData))return;let n=[];for(let s in e.playersData)n.push(new t(e.playersData[s].connect,e.playersData[s].name,e.playersData[s].wins,e.playersData[s].status));let s=new r(n);this._mediator.mainPage().playersPanel().innerHTML="",this._mediator.mainPage().playersPanel().appendChild(s.build())}isObject(e){return null!==e&&"object"==typeof e}},Game:class{}};class o{constructor(t){this._container=t,this._webSocketAddress=this._container.getAttribute("ws-server"),this._mainPage=new e(this._container),this._mainPage.build()}handleEvent(e){return t=this,i=void 0,l=function*(){if("start"===e){let e=new n(this);this._mainPage.playerPanel().appendChild(e.build());let t=new s(this);this._mainPage.gamePanel().appendChild(t.build())}if("auth"===e){let e=yield(t=this._webSocketAddress,new Promise((function(e,n){var s=new WebSocket(t);s.onclose=function(e){e.wasClean?console.log("Соединение закрыто чисто"):console.log("Обрыв соединения"),console.log("Код: "+e.code+" причина: "+e.reason),console.log(e)},s.onmessage=function(e){console.log("Получены данные "+e.data)},s.onerror=function(e){console.log(e)},s.onopen=function(){e(s)},s.onerror=function(e){n(e)}})));this._webSocketClient=new a(this._webSocketAddress,e,this._player.name()),this._webSocketClient.setMessageHandler(this.MessageHandler.bind(this)),this._webSocketClient.send(`{"controller": "Players", "action": "auth", "data":"${this._player.name()}"}`)}var t;"players"===e&&this._webSocketClient.send('{"controller": "Players", "action":"getPlayers", "data": ""}')},new((r=void 0)||(r=Promise))((function(e,n){function s(e){try{o(l.next(e))}catch(e){n(e)}}function a(e){try{o(l.throw(e))}catch(e){n(e)}}function o(t){var n;t.done?e(t.value):(n=t.value,n instanceof r?n:new r((function(e){e(n)}))).then(s,a)}o((l=l.apply(t,i||[])).next())}));var t,i,r,l}MessageHandler(e){let t=JSON.parse(e.data);new l[t.controller](this,this._webSocketClient)[t.action](t.args)}webSocketClient(){this._webSocketClient}container(){return this._container}mainPage(){return this._mainPage}setPlayer(e){this._player=e}}window.addEventListener("load",(()=>new class{constructor(e){this._selector=e}run(){return e=this,t=void 0,s=function*(){this._container=document.querySelector(this._selector),new o(this._container).handleEvent("start")},new((n=void 0)||(n=Promise))((function(a,i){function r(e){try{o(s.next(e))}catch(e){i(e)}}function l(e){try{o(s.throw(e))}catch(e){i(e)}}function o(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,l)}o((s=s.apply(e,t||[])).next())}));var e,t,n,s}}("#app").run()))})();
//# sourceMappingURL=app.js.map